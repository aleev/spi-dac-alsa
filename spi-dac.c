#include <linux/module.h>
#include <linux/of.h>
#include <linux/err.h>

#include <linux/spi/spi.h>
#include <linux/delay.h>

#ifdef CONFIG_OF
static const struct of_device_id spidac_dt_ids[] = {
	{ .compatible = "za-audio-p1" },
	{},
};
MODULE_DEVICE_TABLE(of, spidac_dt_ids);
#endif

static int snd_spi_write(struct spi_device *spi, const void *buf, size_t len)
{
	struct spi_transfer	t = {
			.tx_buf		= buf,
			.len		= len,
			.cs_change      = 0,
		};
	struct spi_message	m;

	spi_message_init(&m);
	spi_message_add_tail(&t, &m);
	return spi_sync(spi, &m);
}

static int snd_spi_probe(struct spi_device *spi)
{
	printk("Entering Probe function...\n");
	u8 tx_buffer[512] = {
		0x52,0x49,0x46,0x46,0x2c,0xcd,0x00,0x00,0x57,0x41,0x56,0x45,0x66,0x6d,0x74,0x20,0x10,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x11,0x2b,0x00,0x00,0x11,0x2b,0x00,0x00,0x01,0x00,0x08,0x00,0x64,0x61,0x74,0x61,0x07,0xcd,0x00,0x00,0x7d,0x7c,0x7b,0x79,0x78,0x77,0x76,0x77,0x78,0x7a,0x7c,0x7e,0x7f,0x7f,0x7f,0x7e,0x7e,0x7d,0x7d,0x7e,0x7f,0x7f,0x7f,0x7f,0x7e,0x7e,0x7e,0x7d,0x7e,0x7f,0x80,0x80,0x81,0x81,0x80,0x7f,0x80,0x7f,0x7f,0x7f,0x80,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x80,0x7f,0x80,0x81,0x81,0x80,0x80,0x80,0x7f,0x80,0x80,0x81,0x82,0x83,0x84,0x85,0x85,0x88,0x89,0x8a,0x88,0x86,0x84,0x81,0x7d,0x7a,0x79,0x78,0x78,0x78,0x79,0x79,0x78,0x75,0x72,0x70,0x6e,0x6d,0x6f,0x74,0x79,0x7e,0x84,0x88,0x8a,0x8a,0x88,0x86,0x84,0x81,0x7f,0x80,0x80,0x7e,0x7d,0x7b,0x79,0x77,0x75,0x76,0x78,0x7b,0x7e,0x81,0x81,0x7f,0x7d,0x7c,0x7d,0x7d,0x7c,0x7e,0x80,0x81,0x80,0x80,0x80,0x80,0x7f,0x7e,0x80,0x84,0x88,0x88,0x88,0x8a,0x8b,0x8c,0x8f,0x93,0x95,0x97,0x9c,0xa1,0xa4,0xa1,0x97,0x8d,0x84,0x75,0x6b,0x67,0x65,0x65,0x68,0x6c,0x6f,0x6f,0x6a,0x66,0x66,0x66,0x68,0x71,0x7f,0x8b,0x95,0x9e,0xa2,0xa1,0x9b,0x91,0x8a,0x85,0x7c,0x76,0x74,0x70,0x69,0x64,0x5e,0x5b,0x59,0x58,0x5f,0x6b,0x76,0x82,0x8d,0x94,0x96,0x94,0x90,0x8e,0x8b,0x86,0x84,0x83,0x7f,0x7d,0x7b,0x79,0x77,0x76,0x77,0x7c,0x80,0x84,0x8b,0x95,0x9d,0xa5,0xae,0xb7,0xbc,0xb3,0x9a,0x81,0x69,0x48,0x2d,0x28,0x2a,0x2f,0x3d,0x4f,0x61,0x6f,0x72,0x75,0x82,0x8c,0x93,0xa5,0xbd,0xcd,0xd4,0xd7,0xd1,0xc0,0xa6,0x89,0x73,0x61,0x4f,0x46,0x46,0x47,0x46,0x47,0x4c,0x56,0x61,0x6f,0x86,0x9f,0xb0,0xbf,0xca,0xcc,0xc4,0xb7,0xaa,0x9e,0x8f,0x7f,0x77,0x70,0x67,0x61,0x60,0x63,0x6a,0x73,0x84,0x9b,0xae,0xbe,0xd4,0xe6,0xe9,0xd7,0xb1,0x85,0x59,0x25,0x00,0x00,0x00,0x00,0x16,0x33,0x4e,0x5f,0x69,0x77,0x8e,0xa2,0xb7,0xd3,0xf0,0xfd,0xf8,0xeb,0xd0,0xa5,0x76,0x4b,0x2d,0x19,0x0c,0x0b,0x17,0x23,0x2e,0x40,0x56,0x6e,0x87,0xa0,0xbc,0xd2,0xda,0xdd,0xda,0xcb,0xb4,0xa0,0x8d,0x7d,0x6c,0x5e,0x57,0x51,0x4a,0x4d,0x59,0x6b,0x83,0x9f,0xc0,0xdf,0xf9,0xff,0xff,0xe4,0xa4,0x6b,0x31,0x00,0x00,0x00,0x00,0x00,0x1f,0x3b,0x5a,0x6d,0x75,0x8e,0xb2,0xcf,0xec,0xff,0xff,0xff,0xf6,0xc8,0x92,0x5b,0x25,0x00,0x00,0x00,0x00,0x0d,0x26,0x3d,0x54,0x6d,0x8f,0xb2,0xc8,
	} ;

	int count = 0;
	int status = 0;
	u8 tmp_buffer[2];

	size_t len = 2;

	struct spi_message m;

	printk("Send SPI Message...\n");

	for(count = 0; count < 10000; count++) {
		tmp_buffer[0] = 0x30 | ((tx_buffer[count%500] >> 4) & 0x0F);
		tmp_buffer[1] = 0x00 | ((tx_buffer[count%500] << 4) & 0xF0);
		status = snd_spi_write(spi, &tmp_buffer, len);
	}

	return status;
}

static int snd_spi_remove(struct spi_device *spi)
{

	return 0;
}

static struct spi_driver spi_dac_driver = {
	.driver		= {
		.name	= "vybrid_spi",
		.of_match_table = of_match_ptr(spidac_dt_ids),
	},
	.probe		= snd_spi_probe,
	.remove		= snd_spi_remove,
};

module_spi_driver(spi_dac_driver);

MODULE_AUTHOR("Raashid <raashidmuhammed@zilogic.com>");
MODULE_DESCRIPTION("Sound driver for SPI DAC");
MODULE_LICENSE("GPL");
